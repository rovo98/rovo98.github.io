document.addEventListener("DOMContentLoaded",()=>{if(CONFIG.path){let o=!1,n;const s=document.querySelector(".search-input"),g=(e,o,s=!1)=>{const a=[],l=new Set;return e.forEach(t=>{if(CONFIG.localsearch.unescape){const e=document.createElement("div");e.innerText=t,t=e.innerHTML}var n=t.length;if(0!==n){let e=0;var r;for(s||(o=o.toLowerCase(),t=t.toLowerCase());-1<(r=o.indexOf(t,e));)a.push({position:r,word:t}),l.add(t),e=r+n}}),a.sort((e,t)=>e.position!==t.position?e.position-t.position:t.word.length-e.word.length),[a,l]},f=(e,t,n)=>{var r;let{position:o,word:s}=r=n[0];const a=[],l=new Set;for(;o+s.length<=t&&0!==n.length;){l.add(s),a.push({position:o,length:s.length});var c=o+s.length;for(n.shift();0!==n.length&&(r=n[0],o=r.position,s=r.word,c>o);)n.shift()}return{hits:a,start:e,end:t,count:l.size}},m=(e,t)=>{let n="",r=t.start;for(var{position:o,length:s}of t.hits)n+=e.substring(r,o),r=o+s,n+=`<mark class="search-keyword">${e.substr(o,s)}</mark>`;return n+=e.substring(r,t.end),n},a=u=>{const p=[];return n.forEach(({title:n,content:r,url:o})=>{var[s,a]=g(u,n),[l,c]=g(u,r),a=new Set([...a,...c]).size,c=s.length+l.length;if(0!==c){const d=[];0!==s.length&&d.push(f(0,n.length,s));let e=[];for(;0!==l.length;){var i=l[0]["position"],h=Math.max(0,i-20),i=Math.min(r.length,i+80);e.push(f(h,i,l))}e.sort((e,t)=>e.count!==t.count?t.count-e.count:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);s=parseInt(CONFIG.localsearch.top_n_per_article,10);0<=s&&(e=e.slice(0,s));let t="";(o=new URL(o,location.origin)).searchParams.append("highlight",u.join(" ")),0!==d.length?t+=`<li><a href="${o.href}" class="search-result-title">${m(n,d[0])}</a>`:t+=`<li><a href="${o.href}" class="search-result-title">${n}</a>`,e.forEach(e=>{t+=`<a href="${o.href}"><p class="search-result">${m(r,e)}...</p></a>`}),t+="</li>",p.push({item:t,id:p.length,hitCount:c,includedCount:a})}}),p},r=()=>{if(o){const n=s.value.trim().toLowerCase();var t=n.split(/[-\s]+/);const r=document.querySelector(".search-result-container");let e=[];0<n.length&&(e=a(t)),1===t.length&&""===t[0]?(r.classList.add("no-result"),r.innerHTML='<div class="search-result-icon"><i class="fa fa-search fa-5x"></i></div>'):0===e.length?(r.classList.add("no-result"),r.innerHTML='<div class="search-result-icon"><i class="far fa-frown fa-5x"></i></div>'):(e.sort((e,t)=>e.includedCount!==t.includedCount?t.includedCount-e.includedCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id),t=CONFIG.i18n.hits.replace(/\$\{hits}/,e.length),r.classList.remove("no-result"),r.innerHTML=`<div class="search-stats">${t}</div>
        <hr>
        <ul class="search-result-list">${e.map(e=>e.item).join("")}</ul>`,"object"==typeof pjax&&pjax.refresh(r))}},t=()=>{const t=!CONFIG.path.endsWith("json");fetch(CONFIG.path).then(e=>e.text()).then(e=>{o=!0,n=t?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(e),n=n.filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e)),r()})},e=()=>{const e=new URL(location.href).searchParams.get("highlight"),n=e?e.split(" "):[];var t=document.querySelector(".post-body");if(n.length&&t){const r=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null),o=[];for(;r.nextNode();)r.currentNode.parentNode.matches("button, select, textarea")||o.push(r.currentNode);o.forEach(e=>{var[t]=g(n,e.nodeValue);t.length&&((t,e,n)=>{const r=t.nodeValue;let o=e.start;const s=[];for(var{position:a,length:l}of e.hits){var c=document.createTextNode(r.substring(o,a));o=a+l;const i=document.createElement("mark");i.className=n,i.appendChild(document.createTextNode(r.substr(a,l))),s.push(c,i)}t.nodeValue=r.substring(o,e.end),s.forEach(e=>{t.parentNode.insertBefore(e,t)})})(e,f(0,e.nodeValue.length,t),"search-keyword")})}};e(),CONFIG.localsearch.preload&&t(),"auto"===CONFIG.localsearch.trigger?s.addEventListener("input",r):(document.querySelector(".search-icon").addEventListener("click",r),s.addEventListener("keypress",e=>{"Enter"===e.key&&r()})),document.querySelectorAll(".popup-trigger").forEach(e=>{e.addEventListener("click",()=>{document.body.classList.add("search-active"),setTimeout(()=>s.focus(),500),o||t()})});const l=()=>{document.body.classList.remove("search-active")};document.querySelector(".search-pop-overlay").addEventListener("click",e=>{e.target===document.querySelector(".search-pop-overlay")&&l()}),document.querySelector(".popup-btn-close").addEventListener("click",l),document.addEventListener("pjax:success",()=>{e(),l()}),window.addEventListener("keyup",e=>{"Escape"===e.key&&l()})}else console.warn("`hexo-generator-searchdb` plugin is not installed!")});