<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/my-favicon-16x16.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"rovo98.github.io","root":"/","images":"/images","scheme":"Mist","version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="本文主要介绍数据湖 (DataLake)、数据仓库 (Data Warehouse) 以及湖仓一体架构（Lakehouse）相关概念和知识，作为进一步学习和研究相关技术的前置知识。"><meta property="og:type" content="article"><meta property="og:title" content="Warehouse vs DataLake vs Lakehouse"><meta property="og:url" content="http://rovo98.github.io/posts/7f67dfba/index.html"><meta property="og:site_name" content="rovo98&#39;s Blog"><meta property="og:description" content="本文主要介绍数据湖 (DataLake)、数据仓库 (Data Warehouse) 以及湖仓一体架构（Lakehouse）相关概念和知识，作为进一步学习和研究相关技术的前置知识。"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://rovo98.github.io/images/bigdata/datawarehouse-vs-datalake-vs-lakehouse-databricks-dig.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/data-warehouse-data-ingestion-dig.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/data-warehouse-modeling-tables.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/fact-dim-table-star-schema-ex.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/dw-inmon-model.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/dw-kimball-model.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/dw-dim-modeling-layers.svg"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/dw-dim-modeling-layers-example.svg"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/datalake-features-dig.svg"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/hadoop-ecosystem.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/lambda-architecture.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/kappa-architecture.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/datalake-architecture-dig.svg"><meta property="og:image" content="http://rovo98.github.io/images/bigdata/datawarehouse-vs-datalake-vs-lakehouse-databricks-dig.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/delta-lake.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/hudi-datalakes.png"><meta property="og:image" content="http://rovo98.github.io/posts/7f67dfba/iceberg-logo.png"><meta property="article:published_time" content="2022-08-21T09:39:00.000Z"><meta property="article:modified_time" content="2022-11-09T08:49:22.932Z"><meta property="article:author" content="rovo98"><meta property="article:tag" content="warehouse"><meta property="article:tag" content="datalake"><meta property="article:tag" content="lakehouse"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://rovo98.github.io/images/bigdata/datawarehouse-vs-datalake-vs-lakehouse-databricks-dig.png"><link rel="canonical" href="http://rovo98.github.io/posts/7f67dfba/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://rovo98.github.io/posts/7f67dfba/","path":"posts/7f67dfba/","title":"Warehouse vs DataLake vs Lakehouse"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Warehouse vs DataLake vs Lakehouse | rovo98's Blog</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="rovo98's Blog" type="application/atom+xml">
</head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">rovo98's Blog</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">Leave your comfort zone!</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">44</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">19</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">37</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-data-warehouse"><span class="nav-number">1.</span> <span class="nav-text">1、Data Warehouse</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E4%BB%93%E6%96%B9%E6%B3%95%E8%AE%BA"><span class="nav-number">1.1.</span> <span class="nav-text">数仓方法论</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#er-%E6%A8%A1%E5%9E%8B-inmon-model"><span class="nav-number">1.1.1.</span> <span class="nav-text">ER 模型 (Inmon model)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%B4%E5%BA%A6%E6%A8%A1%E5%9E%8B-kimball-model"><span class="nav-number">1.1.2.</span> <span class="nav-text">维度模型 (Kimball model)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#inmon-vs-kimball"><span class="nav-number">1.1.3.</span> <span class="nav-text">Inmon vs Kimball</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E4%BB%93%E5%BB%BA%E6%A8%A1"><span class="nav-number">1.2.</span> <span class="nav-text">数仓建模</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-ods-%E5%B1%82%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E5%B1%82"><span class="nav-number">1.2.1.</span> <span class="nav-text">一、ODS 层，数据操作层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-cdm-%E5%B1%82%E5%85%AC%E5%85%B1%E7%BB%B4%E5%BA%A6%E6%A8%A1%E5%9E%8B%E5%B1%82"><span class="nav-number">1.2.2.</span> <span class="nav-text">二、CDM 层，公共维度模型层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89-ads-%E5%B1%82%E5%BA%94%E7%94%A8%E6%95%B0%E6%8D%AE%E5%B1%82"><span class="nav-number">1.2.3.</span> <span class="nav-text">三、ADS 层，应用数据层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%B4%E5%BA%A6%E5%BB%BA%E6%A8%A1%E5%88%86%E5%B1%82%E7%A4%BA%E4%BE%8B"><span class="nav-number">1.2.4.</span> <span class="nav-text">维度建模分层示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E6%A8%A1%E5%9F%BA%E6%9C%AC%E5%8E%9F%E5%88%99"><span class="nav-number">1.2.5.</span> <span class="nav-text">建模基本原则</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E4%BB%93%E8%A7%84%E8%8C%83"><span class="nav-number">1.3.</span> <span class="nav-text">数仓规范</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-%E8%A1%A8%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="nav-number">1.3.1.</span> <span class="nav-text">一、表命名规范</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-%E5%AD%97%E6%AE%B5%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="nav-number">1.3.2.</span> <span class="nav-text">二、字段命名规范</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89-%E5%A4%96%E9%83%A8%E8%A1%A8%E5%8F%8A%E5%8F%A3%E5%BE%84%E8%A7%84%E8%8C%83"><span class="nav-number">1.3.3.</span> <span class="nav-text">三、外部表及口径规范</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-datalake"><span class="nav-number">2.</span> <span class="nav-text">2、DataLake</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E6%B9%96"><span class="nav-number">2.1.</span> <span class="nav-text">什么是数据湖？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%B9%96%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%89%B9%E5%BE%81"><span class="nav-number">2.2.</span> <span class="nav-text">数据湖的基本特征</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84"><span class="nav-number">2.3.</span> <span class="nav-text">数据湖基本架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-lakehouse"><span class="nav-number">3.</span> <span class="nav-text">3、Lakehouse</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B9%96%E4%BB%93%E5%BC%80%E6%BA%90%E6%96%B9%E6%A1%88"><span class="nav-number">3.1.</span> <span class="nav-text">湖仓开源方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#references-more"><span class="nav-number">4.</span> <span class="nav-text">References &amp; more</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="rovo98" src="/images/personal-logo.jpg"><p class="site-author-name" itemprop="name">rovo98</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">44</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">19</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">37</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/rovo98" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rovo98" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://dclunatic.github.io/" title="https:&#x2F;&#x2F;dcLunatic.github.io" rel="noopener" target="_blank">dcLunatic</a></li><li class="links-of-blogroll-item"><a href="https://adj325.github.io/" title="https:&#x2F;&#x2F;adj325.github.io" rel="noopener" target="_blank">Adj325</a></li><li class="links-of-blogroll-item"><a href="https://rovo98.github.io/leetcode-solutions" title="https:&#x2F;&#x2F;rovo98.github.io&#x2F;leetcode-solutions">rovo98's Leetcode Adventure</a></li></ul></div></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="http://rovo98.github.io/posts/7f67dfba/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/personal-logo.jpg"><meta itemprop="name" content="rovo98"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="rovo98's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Warehouse vs DataLake vs Lakehouse</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2022-08-21 17:39:00" itemprop="dateCreated datePublished" datetime="2022-08-21T17:39:00+08:00">2022-08-21</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/BigData/" itemprop="url" rel="index"><span itemprop="name">BigData</span></a> </span></span><span id="/posts/7f67dfba/" class="post-meta-item leancloud_visitors" data-flag-title="Warehouse vs DataLake vs Lakehouse" title="Views"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">Views: </span><span class="leancloud-visitors-count"></span> </span><span class="post-meta-item" title="Views" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">Views: </span><span id="busuanzi_value_page_pv"></span></span></div></div></header><div class="post-body" itemprop="articleBody"><p><img data-src="/images/bigdata/datawarehouse-vs-datalake-vs-lakehouse-databricks-dig.png" alt=""></p><p>本文主要介绍数据湖 (DataLake)、数据仓库 (Data Warehouse) 以及湖仓一体架构（Lakehouse）相关概念和知识，作为进一步学习和研究相关技术的前置知识。</p><span id="more"></span><h2 id="1-data-warehouse"><a class="markdownIt-Anchor" href="#1-data-warehouse"></a> 1、Data Warehouse</h2><p>数据仓库，在“数据仓库之父” <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bill_Inmon">W.H.Inmon</a> 《Building the Data Warehouse》一书中对数据仓库的定义是：<strong>“一个面向主题的、集成的、非易失的、随时间变化的、用来支持管理人员决策的数据集合”。</strong></p><blockquote><p>扩展：Inmon vs Kimball methodology</p></blockquote><ul><li><strong>面向主题</strong>： 业务数据库中的数据主要针对事务处理，各个业务系统之间是相互分离的，而数据仓库中的数据是按照主题进行分组的。</li><li><strong>集成</strong>：数据仓库中存储的数据是从业务数据库中提取出来的，但并不是对原有数据的简单复制，而是经过了抽取、清理、转换（ETL）等工作。业务数据库记录的是每一项业务处理的流水账。这些数据不适合进行分析处理，进入数据仓库之前需要经过一系列计算，同时抛弃一些无关分析处理的数据。</li><li><strong>非易失</strong>：业务数据库中一般只存储短期数据，因此其数据是不稳定的，记录的是系统中数据变化的瞬态。数据仓库中的数据大多表示过去某一时刻的数据，主要用于查询、分析，不像业务系统中的数据库一样经常修改，一般数据仓库构建完成后主要用于访问，不进行修改和删除。</li><li><strong>随时间变化</strong>：数据仓库关注的是历史数据，按时间顺序定期从业务库和日志库里面载入新的数据进行追加，带有时间属性。</li></ul><p>数据抽取到数据仓库的流程示例图如下：</p><p><img data-src="data-warehouse-data-ingestion-dig.png" alt=""></p><p>在数据仓库建模过程中，主要涉及事实表（Fact table）和维度表（Dim table）的建模开发：</p><p>事实表主要围绕业务过程设计，就应用场景来看主要包括<strong>事务事实表</strong>、<strong>周期快照事实表</strong>和<strong>累计快照事实表</strong>：</p><ul><li><strong>事务事实表</strong>：用于描述业务过程，按业务过程的单一性或多业务过程可进一步分为单事务事实表和多事务事实表。其中单事务事实表分别记录每个业务过程，如下单业务记入下单事实表，支付业务记入支付事实表。多事务事实表在同一表中包含了不同业务过程，如下单、支付、签收等业务过程记录在一张表中，通过新增字段来判断属于哪一个业务过程。当不同业务过程有着相似性时可考虑将多业务过程放到多事务事实表中。</li><li><strong>周期快照事实表</strong>：在一个确定的时间间隔内对业务状态进行度量。例如查看一个用户近 1 年付款金额、近 1 年购物次数、近 30 日登录天数等。</li><li><strong>累计快照事实表</strong>：用于查看不同事件之间的时间间隔，例如分析用户从购买到支付的时长、从下单到订单完成的时长等。一般适用于有明确时间周期的业务过程。</li></ul><p><img data-src="data-warehouse-modeling-tables.png" alt=""></p><p>维度表主要用于对事实属性的各个方面描述，例如，商品维度包括商品的价格、折扣、品牌、原厂家、型号等方面信息。维度表开发的过程中，经常会遇到<strong>维度缓慢变化</strong>的情况，对于缓慢变化维一般会采用：1、重写维度值，对历史数据进行覆盖；2、保留多条记录，通过插入维度列字段加以区分；3、开发日期分区表，每日分区记录当日维度的属性；4、开发<strong>拉链表</strong>按时间变化进行全量存储等方式进行处理。</p><p>一个简单的事实表和维度表示例（星型模型）如下：</p><p><img data-src="fact-dim-table-star-schema-ex.png" alt=""></p><p>事实表主要包含维度表属性的度量，如上图中订单事实表的订单交易金额和交易数量；而维度表则主要包含用于计算事实表度量的属性。</p><blockquote><p>Fact Table vs Dimension Table</p><p>1、事实表包含属性（attribute）数量远少于维度表；</p><p>2、事实表包含的记录数比维度表多；</p><p>3、事实表是“窄表”，而维度表是“宽表”；</p><p>4、事实表的属性类型一般包含数字格式和文本格式，而维度表则是文本格式；</p><p>5、事实表基于维度表建立，需要先选择维度；</p><p>6、在模型中，事实表的数量要比维度表少；</p><p>7、事实表主要用于分析和决策支持；维度表则负责存储业务过程的信息；</p></blockquote><h3 id="数仓方法论"><a class="markdownIt-Anchor" href="#数仓方法论"></a> 数仓方法论</h3><p>三范式(3NF)<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>:</p><ul><li>第一范式(1NF): <strong>无重复列</strong>。也叫属性不可分，像学生信息里的电话号码，不能在一个列内存放一个学生的所有电话号码信息，需拆分成多行；</li><li>第二范式(2NF): <strong>非主属性部分依赖于主键</strong>。学生信息表中所有属性都依赖于学生 id；</li><li>第三范式(3NF): <strong>非主属性不存在传递依赖</strong>。学生信息表只能有学院id(这个是其他主属性)，通过这个学院id可以和学院的信息表关联，而不能把每个人的学院信息都全加上。</li></ul><p>OLTP 系统数据主要使用的建模方式便是三范式，从而在事务处理中解决数据的冗余和一致性问题。</p><h4 id="er-模型-inmon-model"><a class="markdownIt-Anchor" href="#er-模型-inmon-model"></a> ER 模型 (Inmon model)</h4><p><img data-src="dw-inmon-model.png" alt=""></p><p>Inmon，也被称为数仓之父，他提出的建模方法是从企业的高度设计一个 3NF 模型，但数仓的 3NF 与 OLTP 中的 3NF 的区别在于，它是站在企业的角度面向主题的抽象，而不是针对具体业务过程。</p><p>Inmon 方法采用自上而下（top-down approach）的建模方式，是从数据源到数据仓库再到数据集市的一种瀑布流开发方法。Inmon 模型以数据源头为导向，首先，需要探索性地去获取尽量符合预期的数据，尝试将数据按照预期划分为不同的表需求。其次，明确数据的清晰规则后将各个任务通过 ETL 由 Stage 层转化到 DW 层，这里 DW 层通常涉及到较多的 UDF 开发，将数据抽象为实体-关系（ER）模型。接着，在完成 DW 的数据治理之后，可以将数据输出到数据集市中做基本的数据组合。最后，将数据集市的数据输出到 BI 系统中去辅助具体业务。</p><blockquote><p>数据仓库与数据集市 - data warehouse vs data mart<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></p><p><strong>数据集市定义</strong></p><p>数据集市是一组特定的、针对某个主题域、某个部分或者某些特殊用户而进行分类的数据集合，也可以说是小型的数据仓库。</p><p><strong>两者区别</strong></p><p>数据仓库是企业级的，能为整个企业各个部门的运行提供决策支持手段；而数据集市则是一种微型的数据仓库，它通常有更少的数据，更少的主题域，以及更少的历史数据，因此是部门级的，一般只能为某个局部范围内的管理人员服务，因此也称为<strong>部门级数据仓库</strong>。</p></blockquote><p>建模涉及的主要步骤：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、高层模型(DW data model)：一个高度抽象的模型，描述主要的主题以及主题间的关系，用于描述企业的业务总体概况；</span><br><span class="line">2、中层模型(Midlevel data model)：在高层模型的基础上，细化主题的数据项；</span><br><span class="line">3、物理模型(Physical data model)：在中层模型的基础上，考虑物理存储，同时基于性能和平台特点进行物理属性的设计，也可能做一些表的合并、分区设计等处理。</span><br></pre></td></tr></table></figure><p>特点：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 数仓非常灵活，能够适应变化；</span><br><span class="line">- 业务处理过程很容易理解；</span><br><span class="line">- 可跨公司处理报告；</span><br><span class="line">- ETL 过程容易出错；</span><br></pre></td></tr></table></figure><h4 id="维度模型-kimball-model"><a class="markdownIt-Anchor" href="#维度模型-kimball-model"></a> 维度模型 (Kimball model)</h4><p><img data-src="dw-kimball-model.png" alt=""></p><p>Kimball 模型，也称为维度模型（Dimensional model）, 由 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Ralph_Kimball">Ralph Kimball</a> 提出，是一种采用自底向上的建模方式，即从数据集市到数据仓库再到数据源（先有数据集市再有数据仓库）。Kimball 模型都是以最终任务为导向的。首先，在得到数据后需要先做数据的探索，尝试将数据按照目标先拆分出不同的表需求。其次，在明确数据依赖后将各个任务再通过 ETL 由 Stage 层转化到 DM 层。这里 DM 层数据由若干个事实表和维度表组成。接着，在完成 DM 层的事实表维度表拆分后，数据集市一方面可以直接向 BI 环节输出数据，另一方面可以向 DW 层输出数据，方便后续的多维分析。</p><p>Kimbal 模型的典型代表是<strong>星型模型（star model）</strong><sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>与<strong>雪花模型（snowflake model）</strong><sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>。</p><blockquote><p>星型模型和雪花模型都是多维数据模型，雪花模型可以看作是星型模型的扩展形式。可以参考<a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/difference-between-star-schema-and-snowflake-schema">Difference between-star-schema-and-snowflake-schema</a> 了解两者间的差异。</p></blockquote><p>建模主要步骤<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、选择业务过程，业务过程可能是交易的支付、下单等，也可能是当前用户余额等；</span><br><span class="line">2、选择粒度，粒度是维度的组合，例如：国家粒度、城市粒度等；</span><br><span class="line">3、识别维度，通过选择的粒度从而设计好维表；</span><br><span class="line">4、选择事实，确定分析需要的指标。</span><br></pre></td></tr></table></figure><p>特点：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 构建速度快</span><br><span class="line">- 针对多星型模型生成报表很成功</span><br><span class="line">- 数据库操作非常高效</span><br><span class="line">- 占用空间小，管理容易</span><br></pre></td></tr></table></figure><h4 id="inmon-vs-kimball"><a class="markdownIt-Anchor" href="#inmon-vs-kimball"></a> Inmon vs Kimball</h4><table><thead><tr><th>对比项</th><th>Kimball</th><th>Inmon</th></tr></thead><tbody><tr><td>方式</td><td>自底向上实现</td><td>自顶向下实现</td></tr><tr><td>数据集成</td><td>专注于独立的业务域</td><td>站在企业角度上考虑业务域</td></tr><tr><td>构建时间</td><td>高效，所需时间少</td><td>复杂，花费大量时间</td></tr><tr><td>开销</td><td>迭代式，成本效益高</td><td>初始化开销大，开发开销小</td></tr><tr><td>技能需求</td><td>不需要专家团队，由通用团队可完成</td><td>需要专家才能搭建</td></tr><tr><td>可维护性</td><td>困难</td><td>简单</td></tr><tr><td>数据模型</td><td>数据存储于非正则化(denormalized)模型</td><td>数据存储于正则化(normalized)模型</td></tr><tr><td>数据存储系统</td><td>源数据系统高度稳定</td><td>源数据系统频繁变化</td></tr></tbody></table><p>Inmon 模型从数据本身出发构造模型，对数据规范的要求更高，设计性更好，在多变的互联网里较难出结果，而 Kimball 模型从业务需求出发设计模型，更加适合互联网数仓。</p><h3 id="数仓建模"><a class="markdownIt-Anchor" href="#数仓建模"></a> 数仓建模</h3><p>在数仓建模中，优秀的分层设计能够让整个数据体系更易理解和使用。分层的意义：</p><p>1、理清业务数据：随着数据量和业务数据表的不断扩张，需要我们理清数据作用域，可以清晰地找到数据来源；</p><p>2、避免重复计算：为了避免多次计算，多次关联多张表，分层可以保存中间结果，减小开发成本；</p><p>3、增加数据使用便捷性：仓库层的设计，让数据能分析，好分析，能支持大部分数据需求；</p><p>4、避免数据分歧：统一数据口径，保证数据质量，避免出现统一指标多种概念。</p><p>比较通用的简单的维度建模分层，分为三层：</p><p><img data-src="dw-dim-modeling-layers.svg" alt=""></p><h4 id="一-ods-层数据操作层"><a class="markdownIt-Anchor" href="#一-ods-层数据操作层"></a> 一、ODS 层，数据操作层</h4><p>ODS (operation data store)，把操作系统的数据几乎无处理地存放在数仓中，主要有以下工作：</p><ol><li>将业务结构化数据增量或全量的同步进来；</li><li>将日志等非结构化的数据结构化处理后落地到数仓中；</li><li>累计历史数据，根据数据业务需求、审计等要求保存历史数据、清洗数据，保留的数据快照也便于回溯。</li></ol><h4 id="二-cdm-层公共维度模型层"><a class="markdownIt-Anchor" href="#二-cdm-层公共维度模型层"></a> 二、CDM 层，公共维度模型层</h4><p>存放明细事实数据、维度数据及公共指标汇总数据，统一口径，保持数据一致性，减少数据重复计算，CDM(common dimensional model) 层分为 DWD(Data Warehouse Detail) 和 DWS(Data Warehouse Summary) 层。</p><p><strong>1、DWD 层，明细数据层</strong></p><p>DWD 层对业务数据进行清洗、规范化，例如去除作弊数据，对数据字段进行规范命名从而避免歧义化等，另外可采用<strong>维度退化</strong>手段，将维度退化至事实表中，减少事实表和维度表的关联，提高明细表的易用性。</p><p><strong>2、DWS 层，汇总数据层</strong></p><p>DWS 层，加强指标的维度退化，采用更多的宽表化的手段构建公共指标数据层，提升公共指标的复用性，减少重复加工。</p><h4 id="三-ads-层应用数据层"><a class="markdownIt-Anchor" href="#三-ads-层应用数据层"></a> 三、ADS 层，应用数据层</h4><p>ADS (Application Data Service) 层存放数据进行个性化的指标计算，具备不共用性、复杂性（指数型、比值型、排名型）等特性，会基于应用数据组装，想大宽表集市、横标转纵表、趋势指标串等，另外由于 ADS 某些指标具有个性化的特点，尽量不对外提供服务。</p><h4 id="维度建模分层示例"><a class="markdownIt-Anchor" href="#维度建模分层示例"></a> 维度建模分层示例</h4><p><img data-src="dw-dim-modeling-layers-example.svg" alt=""></p><p>1、ODS 层会将各种日志数据及业务库中数据或者其他数据进行落地；</p><p>2、DWD 层，如用户登录表，会做以下一些操作</p><ul><li>去除爬虫等出现异常数据，保持数据质量；</li><li>规范统一数据字段；</li><li>拆解需要拆解的字段；</li><li>融合各端数据；</li></ul><p>3、DWS 层，如用户主题表，会做以下一些操作：</p><ul><li>统计操作轨迹用户数数据；</li><li>统计用户购买商品数，登录次数，订单数，退货数等；</li><li>增加用户维度，时间维度；</li></ul><p>4、ADS 层，如用户转化漏斗，可以利用 DWS 层数据进行维度分析，分析漏斗，为产品做决策支持；</p><h4 id="建模基本原则"><a class="markdownIt-Anchor" href="#建模基本原则"></a> 建模基本原则</h4><p><strong>1、高内聚低耦合</strong></p><p>主要从数据业务特性和访问特性两个角度考虑：</p><p>将业务相近或者相关、粒度相同的数据设计为一个逻辑或者物理模型；</p><p>将高概率同时访问的数据放在一起，将低概率同时访问的数据分开存储；</p><p><strong>2、核心模型与扩展模型分离</strong></p><p>核心模型包括的字段支持常用的核心业务，扩展模型包括的字段支持个性化或少量应用的需要，不要让扩展模型包括的字段过多地入侵核心模型，破坏核心模型的性能和简洁等。</p><p><strong>3、存储成本与计算性能均衡</strong></p><p>在很多时候，设计可能清晰，但存储成本很高，或存储成本很低但计算逻辑复杂，性能差，为此，建模时需要在存储成本和计算性能之间进行均衡。</p><p><strong>4、公共逻辑下沉及统一</strong></p><p>避免重复计算，需将公共逻辑在底层实现并统一口径。</p><p><strong>5、幂等性</strong></p><p>处理逻辑不变，多次执行的结果需保持一致。</p><p><strong>6、规范性</strong></p><p>相同含义字段需在多表中命名一致，表命名需清晰规范，便于查询及使用。</p><h3 id="数仓规范"><a class="markdownIt-Anchor" href="#数仓规范"></a> 数仓规范</h3><p>规范是数仓实施过程中最重要的要素之一，建模规范化可以尽可能避免一些问题。</p><p>数仓规范主要包含模型分层、表命名规范、字段规范、外部表规范和口径规范，其中模型分层见上文<a href="#%E6%95%B0%E4%BB%93%E5%BB%BA%E6%A8%A1">数仓建模</a>。</p><h4 id="一-表命名规范"><a class="markdownIt-Anchor" href="#一-表命名规范"></a> 一、表命名规范</h4><p>ODS 层：数据接入层</p><p>日志类非结构化表：<code>ods_[数据域]_[自定义内容]_[刷新频率]</code></p><p>业务库结构化同步表：<code>ods_[数据域]_[业务库名]_[表名]_[刷新频率]</code></p><p>DWD 层：明细数据层</p><p><code>dwd_[数据域]_[自定义内容]_[粒度]_[刷新频率]</code></p><p>DWS 层：数据汇总层</p><p><code>dws_[数据域]_[自定义内容]_[粒度]_[刷新频率]</code></p><p>ADS 层：数据应用层</p><p><code>ads_[数据域]_[自定义内容]_[粒度]_[刷新频率]</code></p><table><thead><tr><th>组合标记</th><th>标记含义</th></tr></thead><tbody><tr><td>ma</td><td>按月分区全量更新</td></tr><tr><td>mi</td><td>按月分区增量更新</td></tr><tr><td>da</td><td>按天分区全量更新</td></tr><tr><td>di</td><td>按天分区增量更新</td></tr><tr><td>ha</td><td>按小时分区全量更新</td></tr><tr><td>hi</td><td>按小时分区增量更新</td></tr></tbody></table><h4 id="二-字段命名规范"><a class="markdownIt-Anchor" href="#二-字段命名规范"></a> 二、字段命名规范</h4><p>1、命名</p><ul><li>小写</li><li>下划线分割</li><li>数量字段后缀加 <code>_cnt</code> 等标识</li><li>金额字段后缀加 <code>_price</code> 等标识</li><li>禁止使用 SQL 关键字</li></ul><p>2、字段格式</p><ul><li>浮点数使用 <code>decimal(28,6)</code> 控制精度等</li></ul><p>3、NULL 字段处理</p><ul><li>对于维度字段，需设置为 -1</li><li>对于指标字段，需设置为 0</li></ul><h4 id="三-外部表及口径规范"><a class="markdownIt-Anchor" href="#三-外部表及口径规范"></a> 三、外部表及口径规范</h4><p>使用 Hive 外部表，避免误操作行为；采用合适的数据文件格式和压缩方式，e.g. orc, parquet 等，gz, snappy 等压缩方式；</p><p>口径规范：保证主题域内指标口径一致，无歧义。</p><h2 id="2-datalake"><a class="markdownIt-Anchor" href="#2-datalake"></a> 2、DataLake</h2><h3 id="什么是数据湖"><a class="markdownIt-Anchor" href="#什么是数据湖"></a> 什么是数据湖？</h3><p>尽管数据湖是近期比较热门的一个概念，但它其实并不是什么新兴概念，据 wikipedia，早在 2011 年便有了该术语，它目前是拥有许多不同的定义。</p><blockquote><p>A <strong>datalake</strong> is a system or repository of data stored in its natrual/raw format, usually object blobs or files. A data lake is usually a single store of data including raw copies of source system data, sensor data, social data etc, and transformed data used for tasks such as reporting, visualization, advanced analytics and machine learning. A data lake can include structured data from relational databases (rows and columns), semi-structured data (CSV, logs, XML, JSON), unstructured data (emails, documents, PDFs) and binary data (images, audio, video). A data lake can be established “on premises” (within an organization’s data centers) or “in the cloud” (using cloud services from vendors such as <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Amazon_(company)">Amazon</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Microsoft">Microsoft</a>, or <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Google">Google</a>).<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup></p></blockquote><p>wikipedia 定义：数据湖是一类存储数据自然/原始格式的系统或存储，通常是存储对象块或文件，包括原始系统所产生的原始数据拷贝以及为了各类任务而产生的转换数据，包括来自关系型数据库中的结构化数据（行和列）、半结构化数据（如CSV、日志、XML、JSON)、非结构化数据（如email、文档、PDF等）和二进制数据（如图像、音频、视频等）。数据湖可以建立在组织内或云上的存储。缺乏管理的数据湖一般被称为为数据沼泽（data swamps）。</p><p>AWS 定义数据湖是一个集中式存储库，允许你以任意规模存储所有结构化、半结构化和非结构化数据。</p><p><mark>关于数据湖的定义有很多，但基本围绕以下几个特性展开：</mark></p><ol><li>数据湖需要提供足够用的数据存储能力，能够保存一个企业/组织中的所有数据；</li><li>数据湖可以存储海量的任意类型的数据，包括结构化、半结构化和非结构化数据；</li><li>数据湖中的数据是原始数据，是业务数据的完整副本。数据湖中的数据保持了他们在业务系统中原来的样子；</li><li>数据湖需要具备完善的数据管理能力（元数据管理），可以管理各类数据相关的要素，包括数据源、数据格式、连接信息、数据schema、权限管理等；</li><li>数据需要具备多样化的分析能力，包括但不限于批处理、流式计算、交互式分析及机器学习；同时，还需要提供一定的任务调度和管理能力；</li><li>数据湖具备完善的数据生命周期管理能力。不光需要存储原始数据，还需要能够保存各类分析处理的中间结果，并完整地记录数据分析处理过程，能帮助用户完整详细追溯任意一条数据的产生过程；</li><li>数据湖具备完善的数据获取和数据发布能力。数据湖需要能支撑各种各样的数据源，并能从相关的数据源中获取全量/增量数据；然后规范存储。数据湖能将数据分析处理的结果推送到合适的存储引擎中，满足不同的应用访问需求；</li><li>对大数据的支持，包括超大规模存储以及可扩展的大规模数据处理能力。</li></ol><p><img data-src="datalake-features-dig.svg" alt=""></p><p>需要特别说明的是：</p><p>1、可扩展是指<strong>规模的可扩展和能力的可扩展</strong>。即数据湖不但要能随着数据量的增大，提供足够的存储和计算能力， 还需要根据需求不断提供新的数据处理模式，例如可能一开始业务只需要批处理能力，但随着业务的发展，可能需要交互式的即席分析能力；又随着业务的时效性要求不断提高，可能需要支持实时分析和机器学习等丰富能力。</p><p>2、<strong>以数据为导向</strong>，要求数据湖对用户而言有足够简单易用、帮助用户从复杂的 IT 基础设施运维工作中解脱出来，关注业务、关注模型、关注算法、关注数据。数据湖面向的是数据科学家、分析师。云原生应该是构建数据湖的一种比较理想的构建方式。</p><h3 id="数据湖的基本特征"><a class="markdownIt-Anchor" href="#数据湖的基本特征"></a> 数据湖的基本特征</h3><p>数据湖与数据仓库的对比<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup><sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup>：</p><table><thead><tr><th>特性</th><th>数据仓库</th><th>数据湖</th></tr></thead><tbody><tr><td>数据</td><td>来自事务系统、运营数据库和业务线应用程序的关系数据</td><td>来自 IoT 设备、网站、移动应用程序、社交媒体和企业应用程序的非关系和关系数据</td></tr><tr><td>Schema</td><td>设计在数据仓库实施之前（写入型Schema）</td><td>写入在分析时（读取型Schema）</td></tr><tr><td>性价比</td><td>更快查询结果会带来较高存储成本</td><td>更快查询结果只需较低的存储成本</td></tr><tr><td>数据质量</td><td>可作为重要事实依据的高度监管数据</td><td>任何可以或无法进行监管的数据（例如原始数据）</td></tr><tr><td>用户</td><td>业务分析师</td><td>数据科学家、数据开发人员和业务分析师（使用监管数据）</td></tr><tr><td>分析</td><td>批处理报告、BI 和可视化</td><td>机器学习、预测分析、数据发现和分析</td></tr></tbody></table><p>从数据和计算两个层面进一步分析数据湖具备的特性，在<strong>数据方面</strong>：</p><p>1、<strong>保真性</strong>。数据湖中对于业务系统中的数据都会存储一份“一模一样”的完整拷贝。与数据仓库不同的地方在于，数据湖中必须要保存一份原始数据，其数据格式、数据模式、数据内容都不应该被修改。在这方面，数据湖强调对业务数据原原本本的保存。同时，数据湖应该都能存储任意类型/格式的数据。</p><p>2、<strong>灵活性</strong>。在上述对比表中，“写入型schema”与“读取型schema”，主要是将数据 schema 的设计发生在哪个阶段。对于任何数据应用来说，schema 的设计都是必不可少的环节。“写入型schema”表示 schema 设计需要在数据写入前完成，即必须按照既定 schema 来完成相应数据导入，好处是数据与业务的良好适配，但同时也意味着数仓前期构建成本会比较高，特别是当业务模式不够清晰、业务还处于探索阶段时，数仓的灵活性不够。</p><p>3、<strong>可管理</strong>。数据湖应该提供完善的数据管理能力。既然数据要求保真性和灵活性，那么至少数据湖中会存在两类数据：原始数据和处理后的数据。数据湖中的数据会不断的积累、演化。因此，对于数据管理能力的要求自然会很高，至少应该包含这些数据管理能力：数据源、数据连接、数据格式、数据schema（库/表/行/列）。同时，数据湖是单个企业/组织中统一的数据存放场所，因此，还需要具有一定的权限管理能力。</p><p>4、<strong>可追溯</strong>。数据湖是一个组织/企业中全量数据的存储场所，需要对数据的全生命周期进行管理，包括数据的定义、接入、存储、处理、分析、应用的全过程。一个强大的数据湖实现，需要能做到对期间的任意一条数据的接入、存储、处理、消费过程是可追溯的，能够清楚地重现数据完整产生的过程和流动过程。</p><p>在<strong>计算方面</strong>，数据湖对于计算能力的要求非常广泛，完全取决于业务对计算的要求。</p><p>5、<strong>丰富的计算引擎</strong>。从批处理、流式计算、交互式分析到机器学习，各类计算引擎都属于数据湖应该囊括的范畴。一般情况下，数据的加载、转换、处理会使用批处理计算引擎；需要实时计算的部分会采用流式计算引擎。对于一些探索式的分析场景，可能又需要引入交互式分析引擎。随着大数据技术与人工智能技术的结合越来越紧密，各类机器学习和深度学习算法也不断引入，如 Tensorflow/PyTorch 框架已经支持从 HDFS/S3/OSS 上读取样本数据进行训练。因此，对于一个合格的数据湖而言，计算引擎的可扩展/可插拔，应该是属于它的基础能力。</p><p>6、<strong>多模态的存储引擎</strong>。理论上，数据湖本身应该内置多模态的存储引擎，以满足不同的应用对于数据访问的需求（综合考虑响应时间/并发/访问频次/成本等因素）。但在实际使用过程中，数据湖中的数据通常并不会被高频次的访问，而且相关的应用也多在进行探索式的数据应用，为了达到可接受的性价比，数据湖建设通常会选择相对便宜的存储引擎（如S3/OSS/HDFS/OBS），并且在需要时与外置存储引擎协同工作，以满足多样化的应用需求。</p><h3 id="数据湖基本架构"><a class="markdownIt-Anchor" href="#数据湖基本架构"></a> 数据湖基本架构</h3><p>数据湖可以认为是新一代大数据基础设施。为了更好地理解数据湖的基本架构，我们可以了解一下数据基础设施架构的演进过程。</p><p>1、<strong>第一阶段：以 Hadoop 生态系统为代表的离线数据处理基础设施</strong>。如下图<sup class="footnote-ref"><a href="#fn9" id="fnref9">[9]</a></sup>所示，Hadoop 是以 HDFS 为核心存储；以 YARN 为资源调度，以 MapRedcue(MR) 为基本计算模型的批量数据处理基础设施。围绕这些核心组件，产生了一系列新组件来不断完善整个 Hadoop 生态系统大数据平台的数据处理能力，如面向 SQL 的 HIVE，面向工作流的 OOZIE，面向在线 KV 操作的 Hbase 等。随着人们对数据处理性能的要求越来越高，新的计算模型也被不断提出来，产生了 Spark、Storm 等计算引擎，MR 模型也逐渐演化成 DAG 模型，DAG 模型增加计算模型抽象的并发能力：对每一个计算成进行分解，根据计算过程中的数据 shuffle 操作点对任务进行逻辑切分, 任务被分成一个个 stage，每个 stage 都可以有一个或多个 task，而 task 可以并发执行，从而提升了整个计算过程的并行能力；此外，为减少数据处理过程中的中间结果数据文件写操作，Spark 等计算引擎会尽量使用计算节点的内存来对数据进行缓存，提高了数据处理过程的效率和系统吞吐能力。</p><p><img data-src="hadoop-ecosystem.png" alt=""></p><p>2、<strong>第二阶段：Lambda 架构</strong>，Lambda 架构由 Storm 项目的创建者 Nathan Marz 在 “How to beat the CAP theorem”<sup class="footnote-ref"><a href="#fn10" id="fnref10">[10]</a></sup>一文中提出，该架构主要是为了解决批处理模式无法满足实时性要求高的处理场景的问题，如下图所示。</p><p><img data-src="lambda-architecture.png" alt=""></p><p>如今的大部分应用需求需要批处理搭配流计算使用才能满足，而对于用户来说，他们并不关心底层计算引擎和模型是什么，不论是批处理还是流计算，用户都希望能通过统一的数据模型来返回处理结果。从上面 Lambda 架构图可以看到，数据流入平台后，不管是走何种计算模式，最终的处理结果都会通过服务器层对应用提供，确保了访问的一致性。</p><p>3、<strong>第三阶段：Kappa 架构</strong>，Kappa 架构由 Jay Kreps 在 “Questioning the Lambda Architecture&quot; <sup class="footnote-ref"><a href="#fn11" id="fnref11">[11]</a></sup>一文中提出，如下图所示，旨在解决 Lambda 架构中存在的问题：需要维护两套分布式引擎的不同代码来处理相同的业务以产生同样的结果，同时也增加了研发的复杂性，例如 Nathan Marz 首次提出的 Lambda 架构中，批处理层采用 HDFS，而流处理层则采用 Storm，计算引擎本身存在差异，比较难做到处理统一。Kappa 架构完全基于流计算处理，典型的流计算引擎如 Flink，其扩展性更好，通过加大流计算的并行度、加大流式数据处理的时间窗口，来统一批处理和流处理两种计算模式。</p><p><img data-src="kappa-architecture.png" alt=""></p><p>采用 Kafka + Flink， Kappa 架构可以实现容错的、精准一次性语义、高吞吐低延迟的内存化计算，实现流批执行一体化。但Kappa 架构使用 Kafka 存储数据也会带来一些问题，如缺乏数据管理、查询分析支持等。</p><p>综上，从传统的 Hadoop 生态系统架构到 Lambda 架构，从 Lambda 架构到 Kappa 架构演进，大数据平台基础架构逐渐囊括了应用所需的各类数据处理能力，大数据平台逐渐演化成一个企业/组织的全量数据处理平台。在当前企业实践中，除了关系型数据库（RDBs）依托于各个独立的业务系统外，其余的数据几乎都被考虑纳入大数据平台来进行统一的处理。然而，目前的大数据平台基础架构，大多将视角锁定在了存储和计算上，而忽略了对于数据的资产化管理，这恰恰是数据湖作为新一代大数据基础设施所重点关注的方向之一。</p><p>数据是一类重要资产已经成为了共识，为了更好地利用数据，企业/组织需要对数据资产</p><ul><li>1）进行长期原样存储；</li><li>2）进行有效管理和集中治理；</li><li>3）提供多模式的计算能力满足处理需求；</li><li>4）面向业务，提供统一的数据视图、数据模型与数据处理结果；</li></ul><p>在该背景下，数据湖除具备大数据平台所拥有的各类基础能力外，更强调对于数据的管理、治理和资产化能力。落到具体实现上，数据湖应该拥有一系列数据管理组件，包括：1）数据接入、2）数据搬迁、3）数据治理、4）质量管理；5）资产目录、6）访问控制、7）任务管理、8）任务编排、9）元数据管理等，参考的数据湖系统架构如图所示：</p><p><img data-src="datalake-architecture-dig.svg" alt=""></p><p>(PS: 根据在后文的对 Lakehouse 定义的描述，此系统架构也可以称为湖仓架构)</p><h2 id="3-lakehouse"><a class="markdownIt-Anchor" href="#3-lakehouse"></a> 3、Lakehouse</h2><p>Lakehouse（湖仓）这一概念由 Databricks 出的白皮书“Lakehouse: A New Generation of open platforms that unify data warehousing and advanced analytics”<sup class="footnote-ref"><a href="#fn12" id="fnref12">[12]</a></sup>所提出，指新一代统一数据仓库和高级分析需求的开放平台。</p><blockquote><p>“A lakehouse is a new, open architecture that combines the best elements of data lakes and data warehouses. Lakehouses are enabled by a new system design: implementing transaction management and data management features similar to those in a data warehouse directly on top of low-cost cloud storage in open formats. ” <sup class="footnote-ref"><a href="#fn12" id="fnref12:1">[12:1]</a></sup></p></blockquote><p>Lakehouse 是对数据湖及数据仓库两者优点特性的合并而形成的新型开放架构，直接以开放数据格式的低成本存储构建的数据仓库为基础，实现数据管理功能。</p><p><img data-src="/images/bigdata/datawarehouse-vs-datalake-vs-lakehouse-databricks-dig.png" alt=""></p><p>据此定义，不难发现上文关于数据湖系统架构功能及特性的描述是符合该湖仓定义的，这是因为数据湖存在不同理解和定义导致的，按wikipedia 定义，把数据湖当作是一个具备存储一个企业/组织海量任意类型数据的集中式存储，强调的是数据湖的存储能力，而缺乏管理的数据湖容易成为数据沼泽（data swamps）。在数据湖之上增加数据资产化管理能力，便可以视作湖仓，见上文对数据湖特征和架构的描述。</p><p>Databricks 对 Lakehouse 给出的关键功能定义如下<sup class="footnote-ref"><a href="#fn13" id="fnref13">[13]</a></sup>：</p><ul><li><strong>事务支持（Transaction support）</strong>: 在企业级 lakehouse 中，一般地，数据 pipeline 大多以并发的方式进行数据的读写，因此事务支持能够有效地解决并发场景中的数据一致性问题；</li><li><strong>模式演化和治理（Shcema enforcement and governance）</strong>: Lakehouse 需要支持数据模式演化，以适应数据模式的变化，支持数仓模式，如星型/雪花模式。此外，系统需要拥有健壮的数据治理和审计机制，以确保数据完整性；</li><li><strong>BI 支持</strong>：Lakehouse 支持在源数据上使用 BI 工具。可以避免数据湖中数据要往数据仓库/集市迁移副本而带来的开销，也降低了数据访问和处理的延迟；</li><li><strong>存储与计算解耦（Storage is decoupled from compute）</strong>：指在实践中，数据存储和计算分别使用不同的集群，且各自可根据需求进行扩展；</li><li><strong>开放性（Openess）</strong>: 使用的存储数据格式应该是开放且标准化的，如 Parquet、ORC、AVRO 等，并对许多工具和引擎提供高效地直接数据访问支持的 API；</li><li><strong>支持任意数据类型</strong>：lakehouse 可用于存储来自 RDBs 的结构化数据、XML，日志，CSV 等半结构化数据以及机器学习常用的图像、视频和音频等非结构化数据；</li><li><strong>支持多种计算模式</strong>：能够支撑数据科学、机器学习、SQL 查询分析，批处理和流式计算等多种模式，满足各种数据应用对数据访问的需求；</li><li><strong>端到端的流式支持（End-to-end streaming）</strong>：实时任务需求在许多企业中很常见，支持端到端流式处理，可以消除额外专门为实时数据应用存在的独立系统；</li></ul><h3 id="湖仓开源方案"><a class="markdownIt-Anchor" href="#湖仓开源方案"></a> 湖仓开源方案</h3><p>实现 Lakehouse 的关键思路是在以廉价数据存储（e.g. S3, HDFS 等）构建的数据湖之上实现事务元数据管理层，以实现 ACID 事务管理、版本控制等管理功能。</p><p>目前，若想基于开放文件格式构建湖仓，可以使用 <a target="_blank" rel="noopener" href="https://delta.io/">Delta Lake</a>、<a target="_blank" rel="noopener" href="https://iceberg.apache.org/">Apache Iceberg</a> 或 <a target="_blank" rel="noopener" href="https://hudi.apache.org/">Apache Hudi</a> 来实现。其中，</p><p><img data-src="delta-lake.png" alt=""></p><blockquote><p>Delta Lake 由 databricks 开源</p></blockquote><p><img data-src="hudi-datalakes.png" alt=""></p><blockquote><p>Apache Hudi 由 Uber 开源</p></blockquote><p><img data-src="iceberg-logo.png" alt=""></p><blockquote><p>Apache Iceberg 由 Netflix 开源</p></blockquote><p>它们之间在 ACID 事务支持、分区演化、模式演化、时间旅行、计算引擎支持、社区治理和贡献等的对比可以参考以下内容：</p><ul><li><a target="_blank" rel="noopener" href="https://www.dremio.com/subsurface/comparison-of-data-lake-table-formats-iceberg-hudi-and-delta-lake">https://www.dremio.com/subsurface/comparison-of-data-lake-table-formats-iceberg-hudi-and-delta-lake</a></li><li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=IglAEbxerWg&amp;ab_channel=Dremio">https://www.youtube.com/watch?v=IglAEbxerWg&amp;ab_channel=Dremio</a></li></ul><p>各开源方案的具体内容请自行前往相应官网进行了解和学习。</p><p>至于采用 Iceberg、Hudi 、DeltaLake 构建数据湖仓，在国内外各个公司均有方案实践分享，如：</p><p>1、<a target="_blank" rel="noopener" href="https://hudi.apache.org/blog/2022/07/11/build-open-lakehouse-using-apache-hudi-and-dbt/">https://hudi.apache.org/blog/2022/07/11/build-open-lakehouse-using-apache-hudi-and-dbt/</a></p><p>2、<a target="_blank" rel="noopener" href="https://iceberg.apache.org/blogs">https://iceberg.apache.org/blogs</a></p><p>3、<a target="_blank" rel="noopener" href="https://hudi.apache.org/blog">https://hudi.apache.org/blog</a></p><h2 id="references-more"><a class="markdownIt-Anchor" href="#references-more"></a> References &amp; more</h2><p>1、《Building the Data Warehouse. Fourth Edition》—— William H. Inmon (Bill Inmon)</p><p>2、<a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/difference-between-kimball-and-inmon">https://www.geeksforgeeks.org/difference-between-kimball-and-inmon</a></p><p>3、<a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/difference-between-fact-table-and-dimension-table">https://www.geeksforgeeks.org/difference-between-fact-table-and-dimension-table</a></p><p>4、<a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/difference-between-star-schema-and-snowflake-schema">https://www.geeksforgeeks.org/difference-between-star-schema-and-snowflake-schema</a></p><p>5、Buildling the Data lakehouse - Bill inmon → <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=hUj4Nqwz3GQ">https://www.youtube.com/watch?v=hUj4Nqwz3GQ</a></p><p>6、Bill Inmon - Data Warehousing in 2022, Textual ETL, and More → <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=-ckvw6I9KKw">https://www.youtube.com/watch?v=-ckvw6I9KKw</a></p><p>7、<a target="_blank" rel="noopener" href="https://developpaper.com/data-warehouse-and-data-mart-ods-dw-dwd-dwm-dws-ads/">https://developpaper.com/data-warehouse-and-data-mart-ods-dw-dwd-dwm-dws-ads/</a></p><p>8、<a target="_blank" rel="noopener" href="https://www.cidrdb.org/cidr2021/papers/cidr2021_paper17.pdf">Lakehouse: A New Generation of open platforms that unify data warehousing and advanced analytics</a></p><p>9、<a target="_blank" rel="noopener" href="https://databricks.com/blog/2020/01/30/what-is-a-data-lakehouse.html">https://databricks.com/blog/2020/01/30/what-is-a-data-lakehouse.html</a></p><p>10、<a target="_blank" rel="noopener" href="https://databricks.com/blog/2021/08/30/frequently-asked-questions-about-the-data-lakehouse.html">https://databricks.com/blog/2021/08/30/frequently-asked-questions-about-the-data-lakehouse.html</a></p><p>11、<a target="_blank" rel="noopener" href="https://databricks.com/research/delta-lake-high-performance-acid-table-storage-overcloud-object-stores">https://databricks.com/research/delta-lake-high-performance-acid-table-storage-overcloud-object-stores</a></p><p>12、<a target="_blank" rel="noopener" href="https://towardsdatascience.com/the-key-feature-behind-lakehouse-data-architecture-c70f93c6866f">https://towardsdatascience.com/the-key-feature-behind-lakehouse-data-architecture-c70f93c6866f</a></p><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/normal-forms-in-dbms">https://www.geeksforgeeks.org/normal-forms-in-dbms</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p></li><li id="fn2" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/difference-between-data-warehouse-and-data-mart">https://www.geeksforgeeks.org/difference-between-data-warehouse-and-data-mart</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p></li><li id="fn3" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/star-schema-in-data-warehouse-modeling">https://www.geeksforgeeks.org/star-schema-in-data-warehouse-modeling</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p></li><li id="fn4" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/snowflake-schema-in-data-warehouse-model">https://www.geeksforgeeks.org/snowflake-schema-in-data-warehouse-model</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p></li><li id="fn5" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/dimensional-data-modeling">https://www.geeksforgeeks.org/dimensional-data-modeling</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p></li><li id="fn6" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Data_lake">https://en.wikipedia.org/wiki/Data_lake</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p></li><li id="fn7" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/difference-between-data-lake-and-data-warehouse">https://www.geeksforgeeks.org/difference-between-data-lake-and-data-warehouse</a> <a href="#fnref7" class="footnote-backref">↩︎</a></p></li><li id="fn8" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/big-data/datalakes-and-analytics/what-is-a-data-lake/">https://aws.amazon.com/cn/big-data/datalakes-and-analytics/what-is-a-data-lake/</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p></li><li id="fn9" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://www.edureka.co/blog/hadoop-ecosystem">https://www.edureka.co/blog/hadoop-ecosystem</a> <a href="#fnref9" class="footnote-backref">↩︎</a></p></li><li id="fn10" class="footnote-item"><p><a target="_blank" rel="noopener" href="http://nathanmarz.com/blog/how-to-beat-the-cap-theorem.html">http://nathanmarz.com/blog/how-to-beat-the-cap-theorem.html</a> <a href="#fnref10" class="footnote-backref">↩︎</a></p></li><li id="fn11" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://www.oreilly.com/radar/questioning-the-lambda-architecture/">https://www.oreilly.com/radar/questioning-the-lambda-architecture/</a> <a href="#fnref11" class="footnote-backref">↩︎</a></p></li><li id="fn12" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://www.cidrdb.org/cidr2021/papers/cidr2021_paper17.pdf">https://www.cidrdb.org/cidr2021/papers/cidr2021_paper17.pdf</a> <a href="#fnref12" class="footnote-backref">↩︎</a> <a href="#fnref12:1" class="footnote-backref">↩︎</a></p></li><li id="fn13" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://databricks.com/blog/2020/01/30/what-is-a-data-lakehouse.html">https://databricks.com/blog/2020/01/30/what-is-a-data-lakehouse.html</a> <a href="#fnref13" class="footnote-backref">↩︎</a></p></li></ol></section></div><footer class="post-footer"><div class="post-copyright"><ul><li class="post-copyright-author"><strong>Written by: </strong>rovo98</li><li class="post-copyright-link"><strong>Post link: </strong><a href="http://rovo98.github.io/posts/7f67dfba/" title="Warehouse vs DataLake vs Lakehouse">http://rovo98.github.io/posts/7f67dfba/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.</li></ul></div><div class="post-tags"><a href="/tags/warehouse/" rel="tag"><i class="fa fa-tag"></i> warehouse</a> <a href="/tags/datalake/" rel="tag"><i class="fa fa-tag"></i> datalake</a> <a href="/tags/lakehouse/" rel="tag"><i class="fa fa-tag"></i> lakehouse</a></div><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a href="/posts/a0c2ec7f/" rel="next" title="fcitx5-rime 小鹤音形隐藏打字候选窗">fcitx5-rime 小鹤音形隐藏打字候选窗 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">rovo98</span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="Total Visitors"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="Total Views"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a></div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="/js/third-party/search/local-search.js"></script><script src="/js/third-party/fancybox.js"></script><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"jUwzFlXSJ71zpvuEefX2F1aD-gzGzoHsz","app_key":"duLPBvpLL5Q5WAnwRHnBDaR5","server_url":"https://juwzflxs.lc-cn-n1-shared.com","security":false}</script><script src="/js/third-party/statistics/lean-analytics.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.16/dist/katex.min.css" integrity="sha256-e8fkE+LP8R8PMyAaC6jji0vzbcvXB0WnNxM/19zvcdU=" crossorigin="anonymous"><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":100,"height":180},"mobile":{"show":false},"log":false,"tagMode":false});</script></body></html>